# Assignment 3

## Load all libraries
```{r, warning=FALSE}
library(magrittr)
library(readr)
library(dplyr)
library(tidyr)
library(cluster)
```

## Get 5000 most variable genes

This code chunk only needs to be run once to generate the topGenes.RDS file.
One the RDS object has been generated, skip straight to "Read in data".
```{r}
deseq <- readRDS("deseq.RDS")
deseq_df <- readRDS("deseq_df.RDS")
collapsed_mapping_df <- readRDS("collapsed_mapping_df.RDS")

deseq_df <- deseq_df %>%
  inner_join(collapsed_mapping_df, by = c("Gene" = "ensembl_gene_id"))
mat <- counts(deseq, normalized = T)[deseq_df$Gene,]

topGenesMat <- head(order(rowVars(mat), decreasing = TRUE), 5000)
topGenes <- mat[topGenesMat,]

topGenesMat <- head(order(rowVars(mat), decreasing = TRUE), 10000)
topGenes10k <- mat[topGenesMat,]

saveRDS(topGenes, "topGenes.RDS")
saveRDS(topGenes10k, "topGenes10k.RDS")
```

## Read in data
```{r}
topGenes <- readRDS("topGenes.RDS")
topGenes10k <- readRDS("topGenes10k.RDS")
```

## K-means
```{r}
library(cluster)

set.seed(999)

topGenes_df <- as.data.frame(topGenes)
topGenes10k_df <- as.data.frame(topGenes10k)

# Check optimal number of clusters
fviz_nbclust(x = topGenes, FUNcluster = kmeans, method="wss")

# 1 cluster
km_res_1 <- kmeans(x = topGenes,
                centers = 1,
                iter.max = 10,
                nstart = 25)

# 2 clusters 
km_res_2 <- kmeans(x = topGenes,
                centers = 2,
                iter.max = 10,
                nstart = 25)

# 3 clusters 
km_res_3 <- kmeans(x = topGenes,
                centers = 3,
                iter.max = 10,
                nstart = 25)

# 4 clusters 
km_res_4 <- kmeans(x = topGenes,
                centers = 4,
                iter.max = 10,
                nstart = 25)

# 10 clusters 
km_res_10 <- kmeans(x = topGenes,
                centers = 10,
                iter.max = 10,
                nstart = 25)

# Visualize clusters
fviz_cluster(km_res_4, topGenes, geom = ("point"))

# Top 10 genes
topGenes_df_test <- head(topGenes_df, 10)
km_res_top10 <- kmeans(x = topGenes_df_test,
                centers = 3,
                iter.max = 10,
                nstart = 25)

# Top 100 genes
topGenes_df_test <- head(topGenes_df, 100)
km_res_top100 <- kmeans(x = topGenes_df_test,
                centers = 3,
                iter.max = 10,
                nstart = 25)

# Top 1000 genes
topGenes_df_test <- head(topGenes_df, 1000)
km_res_top1000 <- kmeans(x = topGenes_df_test,
                centers = 3,
                iter.max = 10,
                nstart = 25)

# Top 10k genes
topGenes_df_test <- head(topGenes10k_df, 10000)
km_res_top10k <- kmeans(x = topGenes_df_test,
                centers = 3,
                iter.max = 10,
                nstart = 25)
```

## Hierarchical Clustering
```{r}
library(factoextra) # clustering visualization
set.seed(999)

# Perform normalization -- NOT COMPLETED

# Transpose matrix 
trans_topGenes = t(topGenes)
trans_topGenes_df = t(topGenes_df)

# Check optimal number of clusters
fviz_nbclust(x = trans_topGenes, FUNcluster = hcut, method="wss")


distance <- dist(trans_topGenes_df, method = "euclidean")
hc_res  <- hclust(distance, method = "complete")

# 1 cluster
hc_res_1 <- cutree(hc_res, k = 1)

# 2 clusters 
hc_res_2 <- cutree(hc_res, k = 2)

# 3 clusters 
hc_res_3 <- cutree(hc_res, k = 3)

# 4 clusters 
hc_res_4 <- cutree(hc_res, k = 4)

# 10 clusters 
hc_res_10 <- cutree(hc_res, k = 10)

# Visualize dendrogram
h <- plot(hc_res, cex = 0.6, hang = -1)
rect.hclust(hc_res, k = 2, border = 2:5)

# Visualize clusters
fviz_cluster(list(data = trans_topGenes, cluster = hc_res_2), geom = ("point"))


# Top 10 genes
topGenes_df_test <- head(scale(scale(topGenes_df)), 10)
distance <- dist(t(topGenes_df_test), method = "euclidean")
hc_res_top10  <- hclust(distance, method = "complete")
plot(hc_res_top10, cex = 0.6, hang = -1)
hc.cut <- cutree(hc_res_top10, k = 2)
fviz_cluster(list(data = trans_topGenes, cluster = hc.cut), geom = ("point"))

# Top 100 genes
topGenes_df_test <- head(scale(scale(topGenes_df)), 100)
distance <- dist(t(topGenes_df_test), method = "euclidean")
hc_res_top100  <- hclust(distance, method = "complete")
plot(hc_res_top100, cex = 0.6, hang = -1)
hc.cut <- cutree(hc_res_top100, k = 2)
fviz_cluster(list(data = trans_topGenes, cluster = hc.cut), geom = ("point"))

# Top 1000 genes
topGenes_df_test <- head(scale(scale(topGenes_df)), 1000)
distance <- dist(t(topGenes_df_test), method = "euclidean")
hc_res_top1000  <- hclust(distance, method = "complete")
plot(hc_res_top1000, cex = 0.6, hang = -1)
hc.cut <- cutree(hc_res_top1000, k = 2)
fviz_cluster(list(data = trans_topGenes, cluster = hc.cut), geom = ("point"))

# Top 10k genes
topGenes_df_test <- head(scale(scale(topGenes10k_df)), 10000)
distance <- dist(t(topGenes_df_test), method = "euclidean")
hc_res_top10000  <- hclust(distance, method = "complete")
plot(hc_res_top10000, cex = 0.6, hang = -1)
hc.cut <- cutree(hc_res_top10000, k = 2)
fviz_cluster(list(data = trans_topGenes, cluster = hc.cut), geom = ("point"))
```

##PAM Clustering: 
```{r}
library(cluster)

set.seed(999)

topGenes_df <- as.data.frame(topGenes)
topGenes10k_df <- as.data.frame(topGenes10k)

# Check optimal number of clusters
fviz_nbclust(x = topGenes, FUNcluster = pam, method = "wss")

# 1 cluster
pam_res_1 <- pam(x = topGenes, k = 1)

# 2 clusters
pam_res_2 <- pam(x = topGenes, k = 2)

# 3 clusters
pam_res_3 <- pam(x = topGenes, k = 3)

# 4 clusters
pam_res_4 <- pam(x = topGenes, k = 4)

# 10 clusters
pam_res_10 <- pam(x = topGenes, k = 10)

# Visualize clusters
fviz_cluster(pam_res_4, data = topGenes, geom = "point")

# Top 10 genes
topGenes_df_test <- head(topGenes_df, 10)
pam_res_top10 <- pam(x = topGenes_df_test, k = 3)

# Top 100 genes
topGenes_df_test <- head(topGenes_df, 100)
pam_res_top100 <- pam(x = topGenes_df_test, k = 3)

# Top 1000 genes
topGenes_df_test <- head(topGenes_df, 1000)
pam_res_top1000 <- pam(x = topGenes_df_test, k = 3)

# Top 10k genes
topGenes_df_test <- head(topGenes10k_df, 10000)
pam_res_top10k <- pam(x = topGenes_df_test, k = 3)

cluster_data <- data.frame(
  "Original" = km_res_4$cluster,
  "PAM_2" = pam_res_2$clustering,
  "PAM_3" = pam_res_3$clustering,
  "PAM_4" = pam_res_4$clustering,
  "PAM_10" = pam_res_10$clustering
)

ggplot(cluster_data, aes(axis1 = Original, axis2 = PAM_2, y = after_stat(stratum))) +
  geom_alluvium(aes(fill = as.factor(Original))) +
  geom_stratum(aes(fill = as.factor(PAM_2))) +
  scale_x_discrete(limits = c("Original", "PAM_2", "PAM_3", "PAM_4", "PAM_10")) +
  scale_fill_manual(values = c("orange", "pink")) +
  theme_void() +
  labs(title = "Alluvial Diagram (how different clustering setups changed cluster memberships):",
       x = "Clustering Setup",
       y = "Sample ID")

```

## Alluvial diagram
```{r}
# Need all clustering methods done?
# genes (freq) || cluster method 1 | cluster method 2 | etc?
```

## Heatmaps & dendrograms
```{r}
# Need all clustering methods done

# Heatmap outline
# K means | hclust | PAM | Gaussian | 
```

## Statistics
```{r}
# Need all clustering methods done
```