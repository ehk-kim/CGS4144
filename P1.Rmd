```{r}
# Load the library
library("org.Mm.eg.db")

# to use %>%, forwards value to next expression
library(magrittr)

# to read tsv file
library(readr)
library(dplyr)
library(tidyr)
library(biomaRt)
library(ggfortify)
library(DESeq2)
library(ggplot2)
```

```{r}
# Read in metadata
metadata <- readr::read_tsv("SRP119064/metadata_SRP119064.tsv")

# Read in data
expression_df <- readr::read_tsv("SRP119064/SRP119064.tsv")%>%
  # Convert Gene ID column to rowname
  tibble::column_to_rownames("Gene")
```
```{r}
# Align data and metadata
# Select from expression_df the rows with metadata's refinebio_accession_code
expression_df <- expression_df %>%
  dplyr::select(metadata$refinebio_accession_code)

# Check that they are in the same order
all.equal(colnames(expression_df), metadata$refinebio_accession_code)

expression_df <- expression_df %>%
  tibble::rownames_to_column("Gene")

mart <- useMart('ensembl', dataset = 'mmusculus_gene_ensembl')
```

```{r}
mapping_ensembl_to_symbol <- getBM(
  attributes = c(
    'ensembl_gene_id', 'mgi_symbol'),
  values = expression_df$Gene,
  mart = mart)
```

```{r}
collapsed_mapping_df <- mapping_ensembl_to_symbol %>%
  # Group by Ensembl IDs
  dplyr::group_by(ensembl_gene_id) %>%
  # Collapse the mgi symbols `mapping_df` into one column named `all_symbols`
  dplyr::summarize(all_symbols = paste(mgi_symbol, collapse = ";"))
```

```{r}
final_mapping_df <- collapsed_mapping_df %>%
  # Add the rest of the expression data
  dplyr::right_join(expression_df, by = c("ensembl_gene_id" = "Gene"))
```

```{r}
# Write data frame to output file
readr::write_tsv(final_mapping_df, file.path(
  "results/SRP040561_GeneNames.tsv"
))
```

```{r}
logged_mapping <- final_mapping_df %>% 
  tibble::column_to_rownames("ensembl_gene_id") %>%
  dplyr::select_if(is.numeric) %>%
  log()
```

```{r}
per_gene_median_expressions <- logged_mapping %>%
  rowwise() %>%
  mutate(per_gene_medians = median(c_across(where(is.numeric)), na.rm=TRUE)) %>%
  select(per_gene_medians)
```

```{r}
ggplot(per_gene_median_expressions, aes(x=per_gene_medians)) + 
  geom_density()
```

```{r}
final_mapping_df <- final_mapping_df %>%
  tibble::column_to_rownames("ensembl_gene_id") %>%
  dplyr::select(metadata$refinebio_accession_code)

# Check that they are in the same order
all.equal(colnames(final_mapping_df), metadata$refinebio_accession_code)
```

```{r}
gene_matrix <- round(final_mapping_df)
```

```{r}
metadata <- metadata %>%
  # Get trem2knockout status
  dplyr::mutate(knockout_status = dplyr::case_when(
    stringr::str_detect(refinebio_subject, "wt") ~ "wt",
    stringr::str_detect(refinebio_subject, "trem2ko") ~ "trem2ko"
  )) %>%
  # Get time passed (4 months or 8 months)
  dplyr::mutate(time_passed = dplyr::case_when(
    stringr::str_detect(refinebio_subject, "4m") ~ "4m",
    stringr::str_detect(refinebio_subject, "8m") ~ "8m"
  ))
metadata <- metadata %>%
  dplyr::mutate(
    # Here we define the values our factor variable can have and their order.
    knockout_status = factor(knockout_status, levels = c("wt", "trem2ko"))
  ) %>%
  dplyr::mutate(
    refinebio_specimen_part = factor(refinebio_specimen_part, levels = c("cortex", "hippocampus"))
  ) %>%
  dplyr::mutate(
    time_passed = factor(time_passed, levels = c("4m", "8m"))
  )
```
```{r}
deseq <- DESeqDataSetFromMatrix(gene_matrix, metadata, ~refinebio_specimen_part)
```
```{r}
deseq <- DESeq(deseq)
```
```{r}
plotPCA(DESeqTransform(deseq), intgroup = "refinebio_specimen_part")
```